<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8.3. More C and the stack &#8212; guide 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8.4. Dynamic memory allocation" href="c_dyn.html" />
    <link rel="prev" title="8.2. C and the stack" href="c_stack.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="more-c-and-the-stack">
<h1>8.3. More C and the stack<a class="headerlink" href="#more-c-and-the-stack" title="Permalink to this headline">¶</a></h1>
<div class="section" id="arrays">
<h2>8.3.1. Arrays<a class="headerlink" href="#arrays" title="Permalink to this headline">¶</a></h2>
<p>Arrays are blocks of memory allocated in stack.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">my_array</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">my_array</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">my_array</span><span class="p">));</span>
	<span class="n">my_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">my_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">my_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

</pre></div>
</div>
<p>Here, at the end of main, our stack looks like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">Address</span>    <span class="o">|</span> <span class="n">Contents</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000010</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x5000000c</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000008</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000004</span> <span class="o">|</span> <span class="mi">2</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000000</span> <span class="o">|</span> <span class="mi">3</span>          <span class="o">|</span>
</pre></div>
</div>
<p>In other words, each integer in the array is available in the stack.</p>
</div>
<div class="section" id="arrays-and-functions">
<h2>8.3.2. Arrays and functions<a class="headerlink" href="#arrays-and-functions" title="Permalink to this headline">¶</a></h2>
<p>When passing an array to a function, the array is not copied like a pointer or an integer, but instead a <em>pointer</em> to the first element is passed. The array is said to <em>decay</em> to a pointer:</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="o">*</span><span class="n">array</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">array</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">my_array</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">my_array</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">my_array</span><span class="p">));</span>
	<span class="n">my_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">my_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">func</span><span class="p">(</span><span class="n">my_array</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">my_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
<p>When entering the function &#8220;func&#8221;, our stack looks like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">Address</span>    <span class="o">|</span> <span class="n">Contents</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000020</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x5000001c</span> <span class="o">|</span> <span class="mi">5</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000018</span> <span class="o">|</span> <span class="mh">0x50000000</span> <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000014</span> <span class="o">|</span> <span class="mh">0x12345678</span> <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000010</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x5000000c</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000008</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000004</span> <span class="o">|</span> <span class="mi">2</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000000</span> <span class="o">|</span> <span class="mi">3</span>          <span class="o">|</span>
</pre></div>
</div>
<p>That is, our array is located from 0x50000000 to 0x50000010. We then have the return address due to our function call, a pointer pointing to the first element (variable &#8220;int *array&#8221;), the variable &#8220;len&#8221; which has value 5, and our index variable &#8220;i&#8221; with value 0. (Remember, each variable we define must have its location in the stack.)</p>
<p>What happens in the function &#8220;func&#8221;? The interesting part is the contents of the loop. On line 7, we double the value of the number pointed to by the pointer. We then increment <em>the pointer itself</em>, i.e. <em>the address pointed to</em> by one. Because the pointer is a pointer to int, incrementing the pointer by one effectively makes the pointer point to the next int. This means that after we&#8217;ve iterated through the loop once, our stack looks like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">Address</span>    <span class="o">|</span> <span class="n">Contents</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000020</span> <span class="o">|</span> <span class="mi">1</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x5000001c</span> <span class="o">|</span> <span class="mi">5</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000018</span> <span class="o">|</span> <span class="mh">0x50000004</span> <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000014</span> <span class="o">|</span> <span class="mh">0x12345678</span> <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000010</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x5000000c</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000008</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000004</span> <span class="o">|</span> <span class="mi">2</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000000</span> <span class="o">|</span> <span class="mi">6</span>          <span class="o">|</span>
</pre></div>
</div>
<p>In other words, we&#8217;ve doubled the value at 0x50000000, added 4 (the size of an int in our example) to the pointer at 0x50000014, and added 1 to &#8220;i&#8221;.</p>
<p>Now, after the function has completed and the execution returns to main, our stack looks like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">Address</span>    <span class="o">|</span> <span class="n">Contents</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000010</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x5000000c</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000008</span> <span class="o">|</span> <span class="mi">0</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000004</span> <span class="o">|</span> <span class="mi">4</span>          <span class="o">|</span>
<span class="o">|</span> <span class="mh">0x50000000</span> <span class="o">|</span> <span class="mi">6</span>          <span class="o">|</span>
</pre></div>
</div>
<p>That is, the top addresses are no longer &#8220;officially&#8221; part of the stack and the values in our array have all been doubled.</p>
<p>If you&#8217;re wondering what happens to the memory above the stack when a function call returns, the answer is probably nothing. What the compiler instructs the CPU to do when returning from a function is simply to decrement the <em>stack pointer</em> - a pointer that points to the top of the stack, which is needed when adding new data in the stack. The code to manage the stack pointer is added automatically by the compiler.</p>
</div>
<div class="section" id="stack-overflow">
<h2>8.3.3. Stack overflow<a class="headerlink" href="#stack-overflow" title="Permalink to this headline">¶</a></h2>
<p>Typically, the compiler allocates a chunk of memory for the stack at the beginning of the program execution. The memory is typically eight megabytes. This means that you could possibly - although the behaviour is undefined, meaning the compiler can generate any code - access memory in stack that&#8217;s been allocated but not defined. We can try this out:</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
<p>What happens here is that we first define a variable &#8220;a&#8221;, then a pointer that holds the address of that variable (&#8220;b&#8221;), and finally a pointer that accesses the memory after &#8220;b&#8221;. At the end of the program our stack could look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>| Address    | Contents   |
| 0x50000010 | ?          |
| 0x5000000c | ?          |
| 0x50000008 | 0x5000000c |
| 0x50000004 | 0x50000000 |
| 0x50000000 | 4          |
</pre></div>
</div>
<p>That is, &#8220;a&#8221; has value 4 and &#8220;b&#8221; has the address of &#8220;a&#8221; as value, but &#8220;c&#8221; points to an address in the stack where the contents are unknown. Now, because the behaviour of this program is undefined, the program could output anything, and the output could depend e.g. on the compiler optimisation flags.</p>
<div class="topic">
<p class="topic-title first">Undefined behaviour</p>
<p>Undefined behaviour is a concept that mainly only exists in C and C++ and refers to behaviour which according to the language standard isn&#8217;t defined. The language specifications in these cases explicitly allow the compiler to do anything. What compilers could do is insert code that would crash your program, or possibly send data over a network or reboot the system. What the compilers typically insert is the &#8220;expected&#8221; code - e.g. if you read from a variable or a buffer where the contents are undefined, the compiler will insert code to read from it anyway, such that you might get <em>stale</em> data - for example, the value of a variable that doesn&#8217;t exist anymore. In general, bugs involving undefined behaviour are unpleasant to work with, such that it&#8217;s recommended to avoid undefined behaviour where possible.</p>
</div>
<p>If you do use more than eight megabytes of stack, for example by allocating a very large array, then this is typically caught by the operating system, causing it to send the SIGTERM signal to your program, effectively killing it. This is called stack overflow.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.3. More C and the stack</a><ul>
<li><a class="reference internal" href="#arrays">8.3.1. Arrays</a></li>
<li><a class="reference internal" href="#arrays-and-functions">8.3.2. Arrays and functions</a></li>
<li><a class="reference internal" href="#stack-overflow">8.3.3. Stack overflow</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="int_c_index.html">8. Intermediate C</a><ul>
      <li>Previous: <a href="c_stack.html" title="previous chapter">8.2. C and the stack</a></li>
      <li>Next: <a href="c_dyn.html" title="next chapter">8.4. Dynamic memory allocation</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/c_stack2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Antti Salonen.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/c_stack2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>