<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>12.3. AJAX &#8212; guide 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="12.4. Gluing AJAX and Redis together" href="redis_ajax_glue.html" />
    <link rel="prev" title="12.2. Redis" href="redis.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ajax">
<h1>12.3. AJAX<a class="headerlink" href="#ajax" title="Permalink to this headline">¶</a></h1>
<p>AJAX stands for Asynchronous Javascript and XmlHttpRequest which is quite a mouthful. Before we go through what it is, let&#8217;s explain why we need it.</p>
<p>Remember that what we wanted to do was have a high score list for our guessing game. We have the following constraints:</p>
<ul class="simple">
<li>The client (browser) displays HTML and executes JavaScript</li>
<li>The server has direct access to the database while the client does not</li>
</ul>
<p>These constraints imply the following:</p>
<ul class="simple">
<li>Once the user has guessed the correct number, as we want to store this in the database, the client will need to send this information to the server</li>
<li>In order to update the high score table on the page, the server will need to send the information about the high score list to the client</li>
<li>The above should happen without having to refresh or reload the page</li>
</ul>
<p>From a high level software architecture point of view, then, this is how the flow is expected to work:</p>
<ol class="arabic simple">
<li>User opens the relevant URL in his or her browser and has some means to enter his or her name on the page</li>
<li>Our web server serves the HTML and Javascript that is our guessing game</li>
<li>The user plays the game happily in the browser, executing Javascript, without the server being aware</li>
<li>Once the user guesses the right answer, Javascript sends the number of guesses and the player name to the server</li>
<li>The server stores the number of guesses and the player name in the database</li>
<li>The server fetches the high score list from the database, and send it to the client (Javascript)</li>
<li>The client displays the high score list</li>
</ol>
<p>Seems simple, doesn&#8217;t it?</p>
<p>Apart from entering the name, we&#8217;ve already covered steps 1-3 and to some extent step 5. In this chapter we&#8217;ll cover steps 4 and 6. They&#8217;re basically what AJAX is about.</p>
<p>Before we get to AJAX in detail, you might have noticed that we talk about server and client here, however if we simply load our HTML guessing game in the browser there is no server, only client. This means that we will have to pull up Flask, our web microframework again, as it has the capability of running a web server which we need going forwards.</p>
<p><em>Exercise</em>: Move your guessing game HTML to be served by Flask. To do this, as per Flask documentation, you need to 1) create a directory named &#8220;templates&#8221; and move your HTML file there; 2) Set up a Flask &#8220;hello world&#8221; program such that there&#8217;s a URL which serves your HTML file (using render_template()); and 3) Start Flask and try it out to ensure everything is set up correctly.</p>
<div class="section" id="asynchronous-execution">
<h2>12.3.1. Asynchronous execution<a class="headerlink" href="#asynchronous-execution" title="Permalink to this headline">¶</a></h2>
<p>Asynchronous Javascript and XmlHttpRequest. Asynchronous means that the code is not run synchronously. So far all our code has run synchronously. For example here:</p>
<div class="highlight-js"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">x</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>Line 1 is executed before line 2, which is executed before line 3. Asynchronous execution changes this. Instead we have something like this (not real Javascript code):</p>
<div class="highlight-js"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ServerRequest</span><span class="p">();</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
<p>What happens here is:</p>
<ul class="simple">
<li>Line 1: We create a new variable which is of type ServerRequest</li>
<li>Lines 2-4: We define the <em>callback</em> - a function which will be called later, but not now</li>
<li>Line 5: We send the request to the server (via HTTP)</li>
</ul>
<p>After the request is sent to the server, the server (our Python code) will handle it and send something back (via HTTP). As this goes over the network it can take several milliseconds or even longer depending on what the server does. Once the server has sent the reply, the browser will receive it and its Javascript interpreter will call the function that was defined in lines 2-4 with the data from the server. In this case, the HTML element with ID &#8220;foo&#8221; will have its value changed, i.e. the result from the server is visible to the user.</p>
<p>What makes this asynchronous is that we define code which isn&#8217;t run synchronously with the execution flow otherwise.</p>
</div>
<div class="section" id="xmlhttprequest">
<h2>12.3.2. XmlHttpRequest<a class="headerlink" href="#xmlhttprequest" title="Permalink to this headline">¶</a></h2>
<p>XmlHttpRequest is the API that allows asynchronous communication with the server. It&#8217;s now standardised across browsers such that all major browsers provide this API, allowing us as Javascript programmers to send and receive data from the server via HTTP. It&#8217;s called XmlHttpRequest (probably) because it was originally mainly used to send and receive XML data, but in general it can be used to transfer any data. Specifically, we&#8217;ll be using it to transfer JSON.</p>
<div class="topic">
<p class="topic-title first">XML and JSON</p>
<p>You might wonder, what is this XML that I keep hearing about. XML (Extensible Markup Language) is a markup language that shares many similarities with HTML. Here&#8217;s an example XML document:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;start_tag&gt;</span>
    <span class="nt">&lt;second_tag</span> <span class="na">attribute=</span><span class="s">&quot;value&quot;</span><span class="nt">&gt;</span>
        second tag body
    <span class="nt">&lt;/second_tag&gt;</span>
<span class="nt">&lt;/start_tag&gt;</span>
</pre></div>
</div>
<p>In general, you can define all the values (tag names, attribute keys and values, the contents in the body of a tag) as you wish. In this sense XML can be used to transfer generic data between two programs or components. For this use case XML is very similar to JSON. We&#8217;re focusing on JSON in this book instead of XML because it&#8217;s generally simpler to work with, and seems to be at least as common as XML if not more.</p>
</div>
<p>Here&#8217;s an example of XmlHttpRequest in practice - how to get some data from the server:</p>
<div class="highlight-js"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;file.html&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Data received: &quot;</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Let&#8217;s go through this line by line:</p>
<ul class="simple">
<li>Line 1: We create a new object of type XMLHttpRequest which is the API for getting data from the server</li>
<li>Line 2: We specify that we want to GET data (as opposed to POST), namely by getting file.html</li>
<li>Line 3: We define the callback function which will be called when the server has its response. The syntax used here creates an <em>anonymous function</em> - a function that doesn&#8217;t have a name but is defined. It&#8217;s practical because we can define the function inline as opposed to defining it somewhere else and referencing it here, and it&#8217;s also necessary as we can use variables in it that are in scope in this example (namely &#8220;xhr&#8221;) that wouldn&#8217;t be in scope if we defined it as a named function.</li>
<li>Line 4: We check the state of the request. We want it to be DONE and have the status code 200 (which means &#8220;OK&#8221; in HTTP).</li>
<li>Line 5: If this condition is satisfied then we write text in the console, including the response text from the server. This can be anything - plain text, JSON, XML, binary data - whatever the server is programmed to send.</li>
<li>Line 8: We send the request to the server.</li>
</ul>
<p>Let&#8217;s try this out ourselves.</p>
<p><em>Exercise</em>: Implement the above AJAX request. You&#8217;ll need the following:</p>
<ol class="arabic simple">
<li>Create a new HTML file which has nothing but a button which calls a Javascript function (&lt;input type=&#8221;button&#8221; onclick=&#8221;my_function()&#8221; value=&#8221;Button to GET data&#8221;&gt;), and a Javascript function which does nothing more but the code from the block above.</li>
<li>Add a function in your Python code to serve the above HTML page using Flask (render_template()).</li>
<li>Add another function in your Python code to serve the URL that the AJAX request will request. In the example above, that URL is &#8220;file.html&#8221;. Note that the URL doesn&#8217;t need to have a file extension. That function should return a string, like &#8220;Hello world!&#8221;</li>
<li>Run your Python code using Flask. Navigate to the HTML page that has the button. Open the Javascript console in the browser developer menu. Click the button. You should see the text from the Python server code in the console.</li>
</ol>
<div class="topic">
<p class="topic-title first">GET vs. POST</p>
<p>To summarise, GET and POST are both two &#8220;verbs&#8221; in HTTP - commands the client sends to the server. What are the differences?</p>
<ul class="simple">
<li>GET typically has no data attached to it from the client, except for the URL - it&#8217;s meant to say &#8220;I want to download a page or a file&#8221;</li>
<li>POST can have data - any kind of data - attached to it - it&#8217;s meant to say &#8220;I want to upload data to the server&#8221;</li>
</ul>
<p>The rule of thumb is that if you&#8217;re only reading information from the server - but not changing anything in the server - you should use GET. You should use POST if the action results in changing something on the server, for example adding data in the database.</p>
</div>
<p>The example above requests something from the server. We can also send data to the server by using the HTTP command POST. Here&#8217;s an example of sending a block of JSON:</p>
<div class="highlight-js"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;file.html&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Data received: &quot;</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/json&quot;</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="s1">&#39;my_number&#39;</span><span class="o">:</span> <span class="mi">42</span><span class="p">}));</span>
</pre></div>
</td></tr></table></div>
<p>This looks very similar to the GET request above. The differences are:</p>
<ul class="simple">
<li>Line 2: We use &#8216;POST&#8217; as the first parameter as opposed to &#8216;GET&#8217;</li>
<li>Line 8: We have a new function call, namely setRequestHeader(). This sets the type of data we&#8217;re sending to JSON. We need this so that the server can handle the incoming data properly.</li>
<li>Line 9: We include the data we wish to send as a parameter to send(). We use JSON.stringify to convert JSON to a string. The server will need to parse the JSON when receiving the data.</li>
</ul>
<p><em>Exercise</em>: Add the above POST request in your HTML page. The server should return the same JSON data back but with the number multiplied by 2, e.g. if the client sends &#8220;{&#8216;my_number&#8217;: 42}&#8221; to the server then the server should send back &#8220;{&#8216;my_number&#8217;: 84}&#8221;. Here are some hints to get you started:</p>
<ul class="simple">
<li>In your &#64;app.route Python decorator, you need to explicitly tell Flask you&#8217;re expecing POST requests. You can do this by defining the decorator e.g. like the following: &#64;app.route(&#8220;/post_test/&#8221;, methods=[&#8216;POST&#8217;])</li>
<li>In your function handling the POST request, Flask allows you to access the incoming JSON data by the request.get_json() function: data = request.get_json(). This will automatically parse the JSON data, returning a Python dictionary or a list, depending on the JSON.</li>
<li>You can use json.dumps() to serialise the JSON data in Python to string to be returned from your function, causing the data to be sent to the client.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">12.3. AJAX</a><ul>
<li><a class="reference internal" href="#asynchronous-execution">12.3.1. Asynchronous execution</a></li>
<li><a class="reference internal" href="#xmlhttprequest">12.3.2. XmlHttpRequest</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="int_web_index.html">12. Intermediate web development</a><ul>
      <li>Previous: <a href="redis.html" title="previous chapter">12.2. Redis</a></li>
      <li>Next: <a href="redis_ajax_glue.html" title="next chapter">12.4. Gluing AJAX and Redis together</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/ajax.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Antti Salonen.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/ajax.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>