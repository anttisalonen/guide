

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4.1.8. Monolithic way - parsing &#8212; Software Development: A Pragmatic Approach 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4.1.9. Monolithic way - scheduled arrivals and GPS data" href="bus3.html" />
    <link rel="prev" title="4.1.7. Unix way - merge" href="merge.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="bus3.html" title="4.1.9. Monolithic way - scheduled arrivals and GPS data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="merge.html" title="4.1.7. Unix way - merge"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Software Development: A Pragmatic Approach 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="ch4_index.html" >4. Stage 2</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="design_index.html" accesskey="U">4.1. Larger software</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.1.8. Monolithic way - parsing</a><ul>
<li><a class="reference internal" href="#timestamps">4.1.8.1. Timestamps</a></li>
<li><a class="reference internal" href="#schedule-entry">4.1.8.2. Schedule entry</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="merge.html"
                        title="previous chapter">4.1.7. Unix way - merge</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="bus3.html"
                        title="next chapter">4.1.9. Monolithic way - scheduled arrivals and GPS data</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/bus2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="monolithic-way-parsing">
<h1>4.1.8. Monolithic way - parsing<a class="headerlink" href="#monolithic-way-parsing" title="Permalink to this headline">¶</a></h1>
<p>Now that we&#8217;re to a large part done with the Unix way, let&#8217;s shift focus on the monolithic way where we implement the functionality of our three Python programs in one C++ program.</p>
<p>The basic principle of designing the software top down still applies. Let&#8217;s start with writing down all the things we need to do:</p>
<ul>
<li><p class="first">Parse input files</p>
<blockquote>
<div><ul class="simple">
<li>With GPS data, as with the Python version, we&#8217;ll need to be able to calculate the distance between two points</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Merge the GPS estimates and the scheduled times</p>
<blockquote>
<div><ul class="simple">
<li>This includes writing some code to handle timestamps, more specifically, to calculate the difference between timestamps</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Pass on the text labels to the SDL code that actually renders them</p>
</li>
</ul>
<p>It may also make sense to think about what data types we will have. We&#8217;ll have at least the following:</p>
<ul class="simple">
<li>Timestamp</li>
<li>Historical GPS data</li>
<li>Current GPS data</li>
<li>Schedule entry</li>
<li>Arriving bus entry (either estimated via GPS or scheduled)</li>
<li>Group of text labels</li>
</ul>
<p>In C++ (and in many other languages) it often makes sense to think of each kind of data type as a class. For example, we could have a class for timestamp, with member variables &#8220;hour&#8221; and &#8220;minute&#8221; (both integers), and a function that returns the difference in minutes between two given timestamps.</p>
<p><em>Exercise</em>: Think about the data types listed above. What data (member variables) would they hold? What operations would exist for them?</p>
<div class="section" id="timestamps">
<h2>4.1.8.1. Timestamps<a class="headerlink" href="#timestamps" title="Permalink to this headline">¶</a></h2>
<p>We can then go about implementing each of these classes, one by one, along with the relevant logic. For example, for a timestamp, we could come up with the following class definition:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Time</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="n">Time</span><span class="p">();</span>
        <span class="n">Time</span><span class="p">(</span><span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">hour</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">minute</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Here we define the Time class with two public member variables (as they&#8217;re simple data, there&#8217;s arguably no need to hide the data by making it private) and two constructors. The first constructor should simply generate a timestamp object with both hour and minute set to 0, and the second constructor should set the hour and minute as given. The functions for this class could be defined e.g. as the following:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">Time</span><span class="o">::</span><span class="n">Time</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">hour</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">minute</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">Time</span><span class="o">::</span><span class="n">Time</span><span class="p">(</span><span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">hour</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
    <span class="n">minute</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We now have our (arguably very simple) first class. We already touched upon a function to calculate the difference between two timestamps; while we could have such a function as a member function for the Time class, it&#8217;s also possible to have this as a free standing function. If we implement it as such, it would have the following declaration:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">time_diff</span><span class="p">(</span><span class="k">const</span> <span class="n">Time</span><span class="o">&amp;</span> <span class="n">t1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Time</span><span class="o">&amp;</span> <span class="n">t2</span><span class="p">);</span>
</pre></div>
</div>
<p>In other words, a function that takes two constant Time objects and returns an integer.</p>
<p><em>Exercise</em>: Implement this function and test it.</p>
</div>
<div class="section" id="schedule-entry">
<h2>4.1.8.2. Schedule entry<a class="headerlink" href="#schedule-entry" title="Permalink to this headline">¶</a></h2>
<p>The requirements spec defined the schedule entry to have a route number, a start number and a timestamp. We&#8217;ve identified one task as parsing the schedule information, in other words, reading the relevant file contents and generating a list (std::vector) of schedule entries. For this we need to do the following:</p>
<ul class="simple">
<li>Declare the schedule entry class</li>
<li>Write the functionality to convert a text line to a schedule entry class</li>
<li>Read in a file and call use abovementioned functionality in a loop to generate a vector of schedule entries</li>
</ul>
<p>Let&#8217;s start with the first one.</p>
<p><em>Exercise</em>: Declare the schedule entry class. It should have a route number, a start number and a timestamp as member variables. The first two can be integers while we should instantiate a Time object for the last one.</p>
<p>Now, converting a string which contains space delimited numbers to integers is funny business in C++. A quick online search shows us one way to do this:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sstream&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>
    <span class="c1">// TODO: set contents of line appropriately</span>
    <span class="n">std</span><span class="o">::</span><span class="n">istringstream</span> <span class="n">iss</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">route_nr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">start_nr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hour</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">minute</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">route_nr</span> <span class="o">&gt;&gt;</span> <span class="n">start_nr</span> <span class="o">&gt;&gt;</span> <span class="n">hour</span> <span class="o">&gt;&gt;</span> <span class="n">minute</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Could not parse data&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// TODO: use our integers here</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Let&#8217;s go through this line by line:</p>
<ul class="simple">
<li>Lines 1-2: include string and sstream (stringstream) which we&#8217;ll be needing shortly.</li>
<li>Line 6: the variable line contains our input data.</li>
<li>Line 8: We convert the data from an std::string to std::istringstream. Istringstream allows reading integers from it fairly easily (using the &gt;&gt; operator).</li>
<li>Lines 9-12: We define our variables which will hold the integers we&#8217;ll read in.</li>
<li>Line 13: We use the &gt;&gt; operator to read in four integers. The operator will return false if something went wrong during parsing (for example, the input data contained letters). In this case, we throw an exception.</li>
</ul>
<p>How would you get each line from a file in C++? Another online search reveals a way:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">infile</span><span class="p">(</span><span class="s">&quot;input_file.txt&quot;</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// TODO: use line here</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Let&#8217;s go through this line by line as well:</p>
<ul class="simple">
<li>Lines 1-3: Import iostream, string and fstream (file stream).</li>
<li>Line 7: Instantiate an object of type std::ifstream named infile. We pass the file name to its constructor as the parameter. This object represents an input file we can read data from.</li>
<li>Line 8: Declare an std::string which will hold each line of the file as we read them in.</li>
<li>Line 9: Use the C++ standard function std::getline() which takes two parameters: the input file stream and an std::string. The contents of the next line will be read from the input stream and stored in the string. The function will return false when the whole file was processed, allowing us to use it in a while loop.</li>
</ul>
<p>We should now have everything we need in order to read in the schedule data and generate a vector of schedule entry objects.</p>
<p><em>Exercise</em>: Generate a vector of schedule entry objects by reading in the schedule data file. Test your code.</p>
<p>While we&#8217;re in the parsing business, let&#8217;s go ahead and repeat this for the historical GPS data file.</p>
<p><em>Exercise</em>: Implement a class to hold the historical data. It will need to have some floats as member variables to hold the time it took the bus to reach the bus stop as well as the X and Y coordinate data. Read in a historical GPS data file to a vector of historical data objects.</p>
<p>As per our requirements specification, the only file type we aren&#8217;t yet able to parse is the current GPS data. This data is interesting because it has the integer representing whether the bus has already passed our bus stop or not (0 if not, 2 if passed). As with our Python code, it seems like a good way to make our code clearer to read if we use an enumeration for this. Enums in C++ can e.g. be defined as the following:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="k">class</span> <span class="nc">Kind</span> <span class="p">{</span>
    <span class="n">GPS</span><span class="p">,</span>
    <span class="n">Schedule</span><span class="p">,</span>
    <span class="n">Passed</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This defines a new data type called Kind which is an enumeration: it can only have a value GPS, Schedule, or Passed. (In C, the keyword &#8220;class&#8221; would have to be left out; it can also be left out in C++ but including it improves type safety by prohibiting implicit conversions between the enum and int, potentially reducing bugs).</p>
<p>You can then define and set a variable of this type e.g. with the following:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">Kind</span> <span class="n">my_variable</span> <span class="o">=</span> <span class="n">Kind</span><span class="o">::</span><span class="n">GPS</span><span class="p">;</span>
</pre></div>
</div>
<p>You can also convert an integer to Kind. For example:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">Kind</span> <span class="n">my_variable</span> <span class="o">=</span> <span class="n">Kind</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="c1">// my_variable is now Kind::Schedule</span>
</pre></div>
</div>
<p>By default, with our above definition of the data type, the value 0 is converted to Kind::GPS, value 1 to Kind::Schedule, and value 2 to Kind::Passed.</p>
<p>We should now be able to define a class to hold the current GPS data, and parse a file holding such data.</p>
<p><em>Exercise</em>: Define a class for current GPS data. It should include a member variable of type enum class Kind. Write code to read in a file of current GPS data to generate a vector of objects of your class, and test your code.</p>
<p>Now that we&#8217;re able to parse in all the data we need, it seems that, apart from any necessary glue code, the actual logic we need to implement is reduced to:</p>
<ul class="simple">
<li>Calculating the estimated arrival times from GPS data</li>
<li>Reading in the scheduled bus arrivals based on the current time</li>
<li>Merging the estimated (and already passed) bus arrivals with the scheduled arrivals</li>
<li>Parsing the command line arguments - including parsing time from a string &#8220;hh:mm&#8221; to a timestamp</li>
<li>Converting timestamps to strings of format &#8220;hh:mm&#8221; for displaying purposes and calling the relevant function to display the labels</li>
</ul>
<p>We&#8217;ll address these in the next chapter.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="bus3.html" title="4.1.9. Monolithic way - scheduled arrivals and GPS data"
             >next</a> |</li>
        <li class="right" >
          <a href="merge.html" title="4.1.7. Unix way - merge"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Software Development: A Pragmatic Approach 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="ch4_index.html" >4. Stage 2</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="design_index.html" >4.1. Larger software</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Antti Salonen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>